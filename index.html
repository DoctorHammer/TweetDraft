<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>X Character Counter</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0iYmkgYmktdHdpdHRlci14IiB2aWV3Qm94PSIwIDAgMTYgMTYiPgogIDxwYXRoIGQ9Ik0xMi42Ljc1aDIuNDU0bC01LjM2IDYuMTQyTDE2IDE1LjI1aC00LjkzN2wtMy44NjctNS4wNy00LjQyNSA1LjA3SC4zMTZsNS43MzMtNi41N0wwIC43NWg1LjA2M2wzLjQ5NSA0LjYzM0wxMi42MDEuNzVabS0uODYgMTMuMDI4aDEuMzZMNC4zMjMgMi4xNDVIMi44NjV6Ii8+Cjwvc3ZnPg==">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiB2aWV3Qm94PSIwIDAgMTYgMTYiIGZpbGw9IiMxRDlCRjAiPjxwYXRoIGQ9Ik0xMi42Ljc1aDIuNDU0bC01LjM2IDYuMTQyTDE2IDE1LjI1aC00LjkzN2wtMy44NjctNS4wNy00LjQyNSA1LjA3SC4zMTZsNS43MzMtNi41N0wwIC43NWg1LjA2M2wzLjQ5NSA0LjYzM0wxMi42MDEuNzVabS0uODYgMTMuMDI4aDEuMzZMNC4zMjMgMi4xNDVIMi44NjV6Ii8+PC9zdmc+">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="X Counter">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiWCBDaGFyYWN0ZXIgQ291bnRlciIsInNob3J0X25hbWUiOiJYIENvdW50ZXIiLCJzdGFydF91cmwiOiIuIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5Q0JGZUV3NVRDNDdDbVJ3ZFhKNU1TMWhaRzkzYjNKc1lYSnRaV04wY21sdVp3PT0iLCJzaXplcyI6IjE4MHgxODAiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XSwidGhlbWVfY29sb3IiOiIjMDAwMDAwIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSJ9">
    <style>
        :root {
            --bg-color: #000;
            --text-color: #fff;
            --border-color: #333;
            --accent-color: #2196f3;
            --preview-bg: #000;
            --preview-border: #333;
            --preview-text: #fff;
            --x-blue: #1d9bf0;
            --x-green: #10b981;
            --x-pink: #ec4899;
            --x-gray: #71767b;
            --tweet-bg: #000;
            --tweet-text: #fff;
            --tweet-border: #1f2937;
            --pic-placeholder: #1a1a1a;
            --radius: 12px;
            --safe-left: calc(20px + env(safe-area-inset-left));
            --safe-right: calc(20px + env(safe-area-inset-right));
            --safe-top: calc(20px + env(safe-area-inset-top));
            --safe-bottom: calc(20px + env(safe-area-inset-bottom));
            --url-highlight: rgba(29, 155, 240, .15);
        }
        
        .light-mode {
            --bg-color: #fff;
            --text-color: #000;
            --border-color: #ccc;
            --preview-bg: #f7f9fa;
            --preview-border: #e1e8ed;
            --preview-text: #0f1419;
            --tweet-bg: #fff;
            --tweet-text: #0f1419;
            --tweet-border: #e1e8ed;
            --x-gray: #536471;
            --pic-placeholder: #f0f0f0;
            --url-highlight: rgba(29, 155, 240, .1);
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100dvh; /* Dynamic viewport height: adapts to keyboard */
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fallback for older iOS (<17) without dvh support */
        @supports not (height: 100dvh) {
            html, body {
                height: 100vh;
            }
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color .3s, color .3s;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
            padding: 0 var(--safe-right) 0 var(--safe-left);
        }
        
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            scroll-padding-bottom: 20px; /* Ensures textarea scrolls into view on focus */
            -webkit-overflow-scrolling: touch; /* Smooth iOS momentum scroll */
            scrollbar-width: none; /* Firefox fallback */
            -ms-overflow-style: none; /* IE/Edge fallback */
        }
        
        #main-content::-webkit-scrollbar {
            display: none; /* Hide in WebKit (Safari/Chrome) */
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--tweet-bg);
            border: 1px solid var(--tweet-border);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        
        .counter-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .counter {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            transition: color .3s, transform .2s;
            position: relative;
            text-align: left;
        }
        
        .counter.scale-pulse {
            animation: scale-pulse .3s ease-out;
        }
        
        .url-info {
            font-size: 11px;
            color: var(--x-gray);
            white-space: nowrap;
            cursor: help;
        }
        
        .actions-right {
            display: flex;
            gap: 6px;
            align-items: center;
            flex: none;
            flex-wrap: wrap;
        }
        
        .btn {
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: border-color .3s, color .3s, background-color .3s;
            font-size: 12px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            background: transparent;
            padding: 6px 12px;
            min-height: 32px;
            touch-action: manipulation;
            min-width: 60px;
        }
        
        .btn:hover {
            background-color: rgba(255, 255, 255, .1);
        }
        
        .light-mode .btn:hover {
            background-color: rgba(0, 0, 0, .1);
        }
        
        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }
        
        @keyframes scale-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .tweet-container {
            width: 100%;
            max-width: 36rem;
            background: var(--tweet-bg);
            color: var(--tweet-text);
            border-radius: var(--radius);
            border: 1px solid var(--tweet-border);
            margin: 0 auto 16px;
            flex: none;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
        }
        
        .tweet-container.visible {
            max-height: 500px;
            opacity: 1;
        }
        
        .tweet-inner {
            padding: 12px;
        }
        
        .profile-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .profile-pic {
            position: relative;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .pic-placeholder {
            width: 100%;
            height: 100%;
            background: var(--pic-placeholder);
        }
        
        .user-info {
            flex-grow: 1;
            min-width: 0;
        }
        
        .header-line {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
        }
        
        .display-name {
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .verified {
            width: 16px;
            height: 16px;
            color: var(--x-blue);
            flex-shrink: 0;
        }
        
        .username, .dot, .date {
            color: var(--x-gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .tweet-text {
            font-size: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }
        
        .tweet-text .url,
        .tweet-text .mention,
        .tweet-text .hashtag {
            color: var(--x-blue);
            text-decoration: none;
        }
        
        .tweet-text .cashtag {
            color: var(--x-blue);
            text-decoration: none;
        }
        
        .tweet-text .cashtag:hover {
            text-decoration: underline;
        }
        
        .tweet-text .url:hover,
        .tweet-text .mention:hover,
        .tweet-text .hashtag:hover {
            text-decoration: underline;
        }
        
        .textarea-container {
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: var(--bg-color);
            overflow: hidden;
            -webkit-user-select: text;
            user-select: text;
            flex: 1;
            min-height: 40vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #input-wrapper {
            position: relative;
            flex: 1;
            display: flex;
        }
        
        #input {
            width: 100%;
            height: 100%;
            min-height: 40vh;
            padding: 14px;
            font-size: 16px;
            background: transparent;
            color: var(--text-color);
            border: none;
            outline: none;
            resize: none;
            -webkit-user-select: text;
            user-select: text;
            spellcheck: true;
            autocapitalize: sentences;
            autocomplete: off;
            autocorrect: on;
            data-1p-ignore: true;
            flex: 1;
            position: relative;
            z-index: 2;
        }
        
        #input-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 14px;
            font-size: 16px;
            font-family: inherit;
            line-height: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
            color: transparent;
        }
        
        #input-highlight .url-bg {
            background: var(--url-highlight);
            border-radius: 3px;
        }
        
        #input::placeholder {
            color: var(--x-gray);
            font-size: 15px;
            line-height: 1.5;
        }
        
        #install-prompt {
            position: fixed;
            bottom: var(--safe-bottom);
            left: var(--safe-left);
            right: var(--safe-right);
            background: var(--tweet-bg);
            border: 1px solid var(--tweet-border);
            border-radius: var(--radius);
            padding: 12px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
        }
        
        #install-prompt.show {
            display: flex;
        }
        
        #install-prompt .install-text {
            font-size: 14px;
            flex: 1;
        }
        
        #install-prompt .install-actions {
            display: flex;
            gap: 8px;
        }
        
        #install-prompt .btn {
            min-height: 28px;
            padding: 4px 10px;
            font-size: 11px;
            min-width: 50px;
        }
        
        @media (max-width: 600px) {
            :root {
                --safe-left: calc(10px + env(safe-area-inset-left));
                --safe-right: calc(10px + env(safe-area-inset-right));
            }
            
            .btn {
                font-size: 11px;
                padding: 4px 8px;
                min-width: 55px;
            }
            
            .counter {
                font-size: 20px;
            }
            
            #input {
                min-height: 30vh;
            }
            
            .action-bar {
                padding: 8px 12px;
                gap: 6px;
            }
            
            .url-info {
                font-size: 10px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                padding-left: 24px;
                padding-right: 24px;
            }
            
            #main-content {
                padding-top: calc(24px + env(safe-area-inset-top));
                padding-bottom: calc(24px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <main id="main-content">
        <div class="action-bar">
            <div class="counter-wrapper">
                <div class="counter" id="counter" aria-live="polite" aria-atomic="true">0 / 280</div>
                <span class="url-info" id="url-info" title=""></span>
            </div>
            <div class="actions-right">
                <button class="btn" id="preview-toggle-btn" aria-label="Toggle preview">Preview</button>
                <button class="btn" id="copy-btn" aria-label="Copy text to clipboard">Copy</button>
                <button class="btn" id="toggle" aria-label="Toggle theme">ðŸŒ—</button>
            </div>
        </div>
        
        <div class="tweet-container" id="tweet-container">
            <div class="tweet-inner">
                <div class="profile-row">
                    <div class="profile-pic">
                        <div class="pic-placeholder"></div>
                    </div>
                    <div class="user-info">
                        <div class="header-line">
                            <span class="display-name">user</span>
                            <svg class="verified" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .494.083.964.237 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"></path>
                            </svg>
                            <span class="username">@username</span>
                            <span class="dot">Â·</span>
                            <span class="date" id="date"></span>
                        </div>
                        <div id="preview-text" class="tweet-text"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="textarea-container">
            <div id="input-wrapper">
                <div id="input-highlight"></div>
                <textarea 
                    id="input" 
                    aria-label="Tweet text input"
                    placeholder="Type your X post here...&#10;&#10;URLs count as 23 chars.&#10;Media/polls don't count.&#10;Emojis: most 2 chars.&#10;Test replies on X." 
                    spellcheck="true" 
                    autocapitalize="sentences" 
                    autocomplete="off" 
                    autocorrect="on"
                    data-1p-ignore="true"></textarea>
            </div>
        </div>
    </main>
    <div id="install-prompt">
        <span class="install-text">Add X Counter to your home screen for quick access</span>
        <div class="install-actions">
            <button class="btn" id="install-yes">Add</button>
            <button class="btn" id="install-no">Not now</button>
        </div>
    </div>
    <script>
        if ('serviceWorker' in navigator) {
            const swCode = `const CACHE='x-counter-v3.7';const ASSETS=['.'];self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(cache=>cache.addAll(ASSETS)))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(res=>res||fetch(e.request)))})`;
            const blob = new Blob([swCode], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            navigator.serviceWorker.register(url).catch(() => {});
        }
        
        const input = document.getElementById('input'),
              toggle = document.getElementById('toggle'),
              counter = document.getElementById('counter'),
              previewText = document.getElementById('preview-text'),
              dateEl = document.getElementById('date'),
              urlInfo = document.getElementById('url-info'),
              copyBtn = document.getElementById('copy-btn'),
              previewToggleBtn = document.getElementById('preview-toggle-btn'),
              tweetContainer = document.getElementById('tweet-container'),
              inputHighlight = document.getElementById('input-highlight'),
              limit = 280,
              urlRegex = /(?:(?:https?:\/\/(?:www\.)?)|(?:www\.)|(?<![a-zA-Z0-9-]))[a-zA-Z0-9\u00a1-\uffff][\w\u00a1-\uffff.-]*(?:\.[a-zA-Z]{2,})+(?::\d{2,5})?(?:\/[^\s]*)?(?![a-zA-Z0-9-])/gi;
        
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;");
        }
        
        function getValidUrls(text) {
            return [...text.matchAll(urlRegex)]
                .filter(match => {
                    let href = match[0];
                    if (!href.startsWith('http://') && !href.startsWith('https://')) {
                        href = 'https://' + href;
                    }
                    try {
                        new URL(href);
                        return true;
                    } catch (e) {
                        return false;
                    }
                })
                .map(m => m[0]);
        }
        
        function countTweetChars(str) {
            str = str.normalize('NFC');
            var char2 = str.match(/[^\u0000-\u10ff,\u2000-\u200D,\u2010-\u201F,\u2032-\u2037,\uD800-\uDfff]/g) || [];
            return str.length + char2.length;
        }
        
        const now = new Date(),
              months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        dateEl.textContent = months[now.getMonth()] + ' ' + now.getDate();
        
        toggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            toggle.textContent = document.body.classList.contains('light-mode') ? 'ðŸŒ‘' : 'ðŸŒ•';
        });
        
        previewToggleBtn.addEventListener('click', () => {
            tweetContainer.classList.toggle('visible');
            previewToggleBtn.textContent = tweetContainer.classList.contains('visible') ? 'Hide' : 'Preview';
        });
        
        let prevLength = 0,
            prevOver280 = false;
        
        copyBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            const textToCopy = input.value;
            
            // Method 1: Try Clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyBtn.textContent = 'Copied!';
                    if (navigator.vibrate) navigator.vibrate(50);
                    setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                }).catch(() => {
                    // Fallback if Clipboard API fails
                    fallbackCopy(textToCopy);
                });
            } else {
                // Use fallback method
                fallbackCopy(textToCopy);
            }
        });
        
        function fallbackCopy(text) {
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = text;
            tempTextarea.style.position = 'absolute';
            tempTextarea.style.left = '-9999px';
            tempTextarea.style.top = '0';
            tempTextarea.setAttribute('readonly', '');
            document.body.appendChild(tempTextarea);
            
            // For iOS
            const range = document.createRange();
            range.selectNodeContents(tempTextarea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            tempTextarea.setSelectionRange(0, 999999);
            
            try {
                const successful = document.execCommand('copy');
                copyBtn.textContent = successful ? 'Copied!' : 'Failed';
                if (successful && navigator.vibrate) navigator.vibrate(50);
            } catch (err) {
                copyBtn.textContent = 'Failed';
            }
            
            document.body.removeChild(tempTextarea);
            setTimeout(() => copyBtn.textContent = 'Copy', 2000);
        }
        
        function highlightUrls(text) {
            let result = '';
            let lastIndex = 0;
            const urlMatches = [...text.matchAll(urlRegex)];
            for (let match of urlMatches) {
                result += escapeHtml(text.slice(lastIndex, match.index));
                const escapedMatch = escapeHtml(match[0]);
                result += `<span class="url-bg">${escapedMatch}</span>`;
                lastIndex = match.index + match[0].length;
            }
            result += escapeHtml(text.slice(lastIndex));
            return result;
        }
        
        function stylePreview(text) {
            const entities = [];

            // Collect URL entities
            for (let match of [...text.matchAll(urlRegex)]) {
                let href = match[0];
                if (!href.startsWith('http://') && !href.startsWith('https://')) {
                    href = 'https://' + href;
                }
                try {
                    new URL(href);
                    entities.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        type: 'url',
                        href: href,
                        text: match[0]
                    });
                } catch (e) {
                    // Skip invalid
                }
            }

            // Collect mention entities
            for (let match of [...text.matchAll(/@([a-zA-Z0-9_]+)/g)]) {
                entities.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    type: 'mention',
                    text: match[0]
                });
            }

            // Collect hashtag entities
            for (let match of [...text.matchAll(/#([a-zA-Z0-9_]+)/g)]) {
                entities.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    type: 'hashtag',
                    text: match[0]
                });
            }

            // Collect cashtag entities
            for (let match of [...text.matchAll(/\$([a-zA-Z0-9_]+)/g)]) {
                entities.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    type: 'cashtag',
                    text: match[0]
                });
            }

            // Sort by start position ascending, then by length descending (prefer longer matches)
            entities.sort((a, b) => a.start - b.start || (b.end - b.start) - (a.end - a.start));

            // Merge non-overlapping (keep the first non-overlapping match, preferring longer/earlier)
            const merged = [];
            const covered = new Set();
            for (let ent of entities) {
                let overlaps = false;
                for (let i = ent.start; i < ent.end; ++i) {
                    if (covered.has(i)) {
                        overlaps = true;
                        break;
                    }
                }
                if (!overlaps) {
                    for (let i = ent.start; i < ent.end; ++i) {
                        covered.add(i);
                    }
                    merged.push(ent);
                }
            }

            // Build HTML
            let result = '';
            let lastIndex = 0;
            for (let ent of merged) {
                result += escapeHtml(text.slice(lastIndex, ent.start));
                let linkHtml;
                const escapedText = escapeHtml(ent.text);
                switch (ent.type) {
                    case 'url':
                        linkHtml = `<a href="${ent.href}" class="url" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                        break;
                    case 'mention':
                        linkHtml = `<a href="https://x.com/${ent.text.slice(1)}" class="mention" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                        break;
                    case 'hashtag':
                        linkHtml = `<a href="https://x.com/hashtag/${ent.text.slice(1)}?src=hashtag_click" class="hashtag" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                        break;
                    case 'cashtag':
                        linkHtml = `<a href="https://x.com/search?q=${encodeURIComponent(ent.text)}&src=cashtag_click" class="cashtag" target="_blank" rel="noopener noreferrer">${escapedText}</a>`;
                        break;
                    default:
                        linkHtml = escapedText;
                }
                result += linkHtml;
                lastIndex = ent.end;
            }
            result += escapeHtml(text.slice(lastIndex));
            return result;
        }
        
        function countChars() {
            const text = input.value;
            const urls = getValidUrls(text);
            const weightedFull = countTweetChars(text);
            const urlStringLengths = urls.reduce((acc, u) => acc + u.length, 0);
            const postLen = weightedFull - urlStringLengths + urls.length * 23;
                
            counter.textContent = `${postLen} / ${limit}`;
            previewText.innerHTML = stylePreview(text);
            inputHighlight.innerHTML = highlightUrls(text);
                
            if (urls.length > 0) {
                const breakdown = urls.length === 1 ? '1 URL Ã— 23' : `${urls.length} URLs Ã— 23 = ${urls.length * 23}`;
                urlInfo.textContent = `(${breakdown})`;
                urlInfo.title = `Detected URLs:\n${urls.join('\n')}`;
            } else {
                urlInfo.textContent = '';
                urlInfo.title = '';
            }
                
            updateColor(postLen);
        }
        
        function updateColor(len) {
            let color = '#006400';
            if (len > limit) color = '#f00';
            else if (len >= 235) color = len >= 280 ? '#f44900' : '#ff8c00';
            else if (len >= 188) color = '#ff0';
            else if (len >= 141) color = '#adff2f';
            else if (len >= 94) color = '#90ee90';
            else if (len >= 47) color = '#008000';
            counter.style.color = color;
            
            const currentOver280 = len >= limit;
            
            // Trigger scale-pulse ONLY when crossing 280 threshold
            if (!prevOver280 && currentOver280) {
                counter.classList.add('scale-pulse');
                // Enhanced haptic feedback - double vibration for stronger feel
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                setTimeout(() => counter.classList.remove('scale-pulse'), 300);
            }
            
            prevOver280 = currentOver280;
            prevLength = len;
        }
        
        input.addEventListener('input', countChars);
        
        /* EASY_REVERT_FOCUS: To disable auto-refocus, comment out the lines below until next comment */
        document.addEventListener('click', e => {
            if (e.target !== input && !input.contains(e.target) && window.innerHeight === window.visualViewport?.height) {
                setTimeout(() => input.focus(), 100);
            }
        });
        /* END_EASY_REVERT_FOCUS */
        
        countChars();
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            deferredPrompt = e;
            const prompt = document.getElementById('install-prompt');
            if (!localStorage.getItem('installDismissed')) {
                prompt.classList.add('show');
            }
        });
        
        document.getElementById('install-yes').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
            document.getElementById('install-prompt').classList.remove('show');
        });
        
        document.getElementById('install-no').addEventListener('click', () => {
            localStorage.setItem('installDismissed', '1');
            document.getElementById('install-prompt').classList.remove('show');
        });
    </script>
</body>
</html>